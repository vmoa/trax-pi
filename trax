#!/usr/bin/python3
#
# T-Rax roof controller for the Raspberry Pi
#
# This is a roll-off roof controller specifically designed and built for
# Robert Ferguson Observatory (https://rfo.org) but the code will hopefully
# be generic enough that it can be adapted for other roll-off roofs.
# See README.md for details.

from gpiozero import DigitalInputDevice, DigitalOutputDevice
from datetime import datetime
from time import sleep
import signal
import os

from device import Sensor, Control
import util
from test_mode import TestMode

heartInterval = 1       # Seconds between heartbeats (drives SIGALRM)
statusInterval = 60     # Seconds between status updates without input changes

# Hard coded GPIO setup
weatherOk = Sensor(pin=4, name='wx');
bldgPowerIn = Sensor(pin=17, name='bldg');
mountPowerIn = Sensor(pin=22, name='mntin');
roofPowerIn = Sensor(pin=27, name='roofin');
mountParked = Sensor(pin=25, name='park');
roofOpen = Sensor(pin=23, name='open');
roofClosed = Sensor(pin=24, name='close');

heartLed = Control(pin=13, name='heart')
mountPowerOut = Control(pin=6, name='mntout', active_high=False)
roofPowerOut = Control(pin=5, name='roofout', active_high=False)
laserPowerOut = Control(pin=16, name='laser')
fobOutput = Control(pin=26, name='fob')

def beatHeart(output=0):
    output.on()
    sleep(0.1)
    output.off()
    sleep(0.05)
    output.on()
    sleep(0.1)
    output.off()

def alarmHandler(signum,frame):
    beatHeart(heartLed.device)
    if (int(datetime.now().second) % statusInterval == 0):
        util.printStatus()

import argparse

def main():

    parser = argparse.ArgumentParser(description='T-Rax roof controller.')
    parser.add_argument('--test-mode', dest='test_mode', action='store_true', help='enter test mode')
    args = parser.parse_args()

    # Install alarm hanlder
    signal.signal(signal.SIGALRM, alarmHandler)
    signal.alarm(heartInterval)

    if (args.test_mode):
        test = TestMode()

    util.printStatus();

    # Interrupt loop
    while True:
        signal.pause()
        signal.alarm(heartInterval)

if __name__ == "__main__":
    main()
